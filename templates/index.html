<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂïÜÂìÅÂ±ïÁ§∫Á≥ªÁªü</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@3/lib/index.css">
    <style>
        .product-item {
            margin: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-title {
            padding: 12px;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }
        .product-recommendations {
            margin: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        .recommendation-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .loading-container {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <van-nav-bar title="ÂïÜÂìÅÂ±ïÁ§∫" fixed placeholder />
        
        <van-pull-refresh v-model="refreshing" @refresh="onRefresh">
            <van-list
                v-model:loading="loading"
                :finished="finished"
                finished-text="Ê≤°ÊúâÊõ¥Â§öÂïÜÂìÅ‰∫Ü"
                @load="onLoad"
            >
                <!-- Êé®ËçêÂïÜÂìÅ -->
                <div v-if="recommendations.length > 0" class="product-recommendations">
                    <div class="recommendation-title">üéØ ‰∏∫ÊÇ®Êé®Ëçê</div>
                    <div v-for="product in recommendations" :key="'rec-' + product.id" class="product-item">
                        <van-swipe :autoplay="3000" indicator-color="white">
                            <van-swipe-item 
                                v-for="image in product.main_images" 
                                :key="image.id"
                                @click="showProductMedia(product)"
                            >
                                <img :src="image.url" class="product-image" />
                            </van-swipe-item>
                        </van-swipe>
                        <div class="product-title">{{ product.title }}</div>
                    </div>
                </div>

                <!-- ÂïÜÂìÅÂàóË°® -->
                <div v-for="product in products" :key="product.id" class="product-item">
                    <van-swipe :autoplay="3000" indicator-color="white">
                        <van-swipe-item 
                            v-for="image in product.main_images" 
                            :key="image.id"
                            @click="showProductMedia(product)"
                        >
                            <img :src="image.url" class="product-image" />
                        </van-swipe-item>
                    </van-swipe>
                    <div class="product-title" @click="viewProductDetail(product)">
                        {{ product.title }}
                    </div>
                </div>

                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div v-if="loading" class="loading-container">
                    <van-loading type="spinner" size="24px">Âä†ËΩΩ‰∏≠...</van-loading>
                </div>
            </van-list>
        </van-pull-refresh>

        <!-- Â™í‰ΩìÂ±ïÁ§∫ÂºπÁ™ó -->
        <van-popup v-model="showMediaPopup" position="bottom" round :style="{ height: '100%' }">
            <div style="height: 100%; background: black;">
                <div v-if="currentProduct">
                    <!-- ËßÜÈ¢ëÊí≠Êîæ -->
                    <div v-if="currentProduct.videos.length > 0 && !showDetailImages" style="height: 100%; display: flex; flex-direction: column;">
                        <video 
                            ref="videoPlayer"
                            :src="currentProduct.videos[0].url"
                            controls
                            style="width: 100%; height: 300px; background: #000;"
                            @play="onVideoPlay"
                            @ended="switchToDetailImages"
                        ></video>
                        <div style="padding: 20px; color: white;">
                            <h3>{{ currentProduct.title }}</h3>
                            <van-button type="primary" @click="switchToDetailImages" style="margin-top: 10px;">
                                Êü•ÁúãÂïÜÂìÅËØ¶ÊÉÖ
                            </van-button>
                        </div>
                    </div>
                    
                    <!-- ËØ¶ÊÉÖÂõæÁâá -->
                    <div v-if="showDetailImages || currentProduct.videos.length === 0" style="height: 100%;">
                        <van-swipe 
                            indicator-color="white"
                            @change="onDetailImageChange"
                        >
                            <van-swipe-item v-for="image in currentProduct.detail_images" :key="image.id">
                                <img :src="image.url" style="width: 100%; height: 100%; object-fit: contain;" />
                            </van-swipe-item>
                        </van-swipe>
                    </div>
                </div>
                
                <van-button 
                    round
                    style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none;"
                    @click="closeMedia"
                >
                    ‚úï
                </van-button>
            </div>
        </van-popup>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vant@3/lib/vant.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Ë°å‰∏∫Ë∑üË∏™SDK -->
    <script src="/static/js/behavior-tracker.js"></script>
    
    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;
        
        createApp({
            setup() {
                const products = ref([]);
                const recommendations = ref([]);
                const loading = ref(false);
                const finished = ref(false);
                const refreshing = ref(false);
                const currentPage = ref(1);
                const showMediaPopup = ref(false);
                const currentProduct = ref(null);
                const showDetailImages = ref(false);
                const videoPlayer = ref(null);
                
                // Âä†ËΩΩÂïÜÂìÅÂàóË°®
                const loadProducts = async (page = 1, isRefresh = false) => {
                    try {
                        loading.value = true;
                        const response = await axios.get(`/api/products?page=${page}`);
                        const data = response.data;
                        
                        if (isRefresh) {
                            products.value = data.products;
                        } else {
                            products.value.push(...data.products);
                        }
                        
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µÔºåÂä†ËΩΩÊé®Ëçê
                        if (page === 1) {
                            loadRecommendations();
                        }
                        
                        finished.value = page >= data.pages;
                        currentPage.value = page;
                    } catch (error) {
                        console.error('Âä†ËΩΩÂïÜÂìÅÂ§±Ë¥•:', error);
                        finished.value = true;
                    } finally {
                        loading.value = false;
                    }
                };
                
                // Âä†ËΩΩÊé®ËçêÂïÜÂìÅ
                const loadRecommendations = async () => {
                    try {
                        const response = await axios.get('/api/products/recommendations');
                        recommendations.value = response.data.recommendations || [];
                    } catch (error) {
                        console.error('Âä†ËΩΩÊé®ËçêÂ§±Ë¥•:', error);
                    }
                };
                
                // ÊòæÁ§∫ÂïÜÂìÅÂ™í‰Ωì
                const showProductMedia = (product) => {
                    // Ë∑üË∏™ÂõæÁâáÁÇπÂáª‰∫ã‰ª∂
                    window.behaviorTracker.track('image_click', product.id, {
                        action: 'open_media_viewer'
                    });
                    
                    currentProduct.value = product;
                    showDetailImages.value = product.videos.length === 0;
                    showMediaPopup.value = true;
                };
                
                // Êü•ÁúãÂïÜÂìÅËØ¶ÊÉÖ
                const viewProductDetail = (product) => {
                    window.behaviorTracker.track('title_click', product.id, {
                        action: 'view_product_detail'
                    });
                    window.location.href = `/product/${product.id}`;
                };
                
                // ËßÜÈ¢ëÊí≠Êîæ‰∫ã‰ª∂
                const onVideoPlay = () => {
                    if (currentProduct.value) {
                        window.behaviorTracker.track('video_play', currentProduct.value.id, {
                            video_id: currentProduct.value.videos[0]?.id
                        });
                    }
                };
                
                // ÂàáÊç¢Âà∞ËØ¶ÊÉÖÂõæÁâá
                const switchToDetailImages = () => {
                    showDetailImages.value = true;
                    if (currentProduct.value) {
                        window.behaviorTracker.track('media_switch', currentProduct.value.id, {
                            from: 'video',
                            to: 'images'
                        });
                    }
                };
                
                // ËØ¶ÊÉÖÂõæÁâáÂàáÊç¢‰∫ã‰ª∂
                const onDetailImageChange = (index) => {
                    if (currentProduct.value) {
                        window.behaviorTracker.track('detail_image_view', currentProduct.value.id, {
                            image_index: index
                        });
                    }
                };
                
                // ÂÖ≥Èó≠Â™í‰ΩìÊü•ÁúãÂô®
                const closeMedia = () => {
                    showMediaPopup.value = false;
                    currentProduct.value = null;
                    showDetailImages.value = false;
                    
                    // ÊöÇÂÅúËßÜÈ¢ëÊí≠Êîæ
                    if (videoPlayer.value) {
                        videoPlayer.value.pause();
                    }
                };
                
                // ÂàóË°®Âä†ËΩΩÊõ¥Â§ö
                const onLoad = () => {
                    if (refreshing.value) {
                        products.value = [];
                        refreshing.value = false;
                    }
                    loadProducts(currentPage.value + 1);
                };
                
                // ‰∏ãÊãâÂà∑Êñ∞
                const onRefresh = () => {
                    finished.value = false;
                    loading.value = true;
                    loadProducts(1, true).then(() => {
                        refreshing.value = false;
                    });
                };
                
                onMounted(() => {
                    loadProducts(1, true);
                });
                
                onUnmounted(() => {
                    // Ê∏ÖÁêÜËµÑÊ∫ê
                    if (videoPlayer.value) {
                        videoPlayer.value.pause();
                    }
                });
                
                return {
                    products,
                    recommendations,
                    loading,
                    finished,
                    refreshing,
                    showMediaPopup,
                    currentProduct,
                    showDetailImages,
                    videoPlayer,
                    onLoad,
                    onRefresh,
                    showProductMedia,
                    viewProductDetail,
                    onVideoPlay,
                    switchToDetailImages,
                    onDetailImageChange,
                    closeMedia
                };
            }
        }).use(vant).mount('#app');
    </script>
</body>
</html>
